<!DOCTYPE html>
<html>
<head>
  <title>Philly Flu-shot Finder</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="viewport" 
    content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=2.0, user-scalable=no">
	<link rel="stylesheet" type="text/css" href="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.css">
  <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.min.css">
	<style type="text/css">
		html, body{
			padding: 0px;
			margin: 0px;
			height: 100%;
			width: 100%;
		}
    #nav{
      height: 36px;
      background: #2376c7;
      box-shadow: 0px 0px 6px 1px #000;
      position: relative;
      z-index: 1;
      width: 100%;
    }

    #nav .row{
      line-height: 36px;
      vertical-align: middle;
      color: white;
      width: 100%;
    }
    
    .menu{
      border: 1px solid #cfcfcf;
      border-radius: 4px;
      width: 20px;
      height: 20px;
      display: inline-block;
      vertical-align: middle;
    }

    #map{
			height: 95%;
			width: auto;
		}
    
    @-webkit-keyframes glow {
       0% {
           box-shadow: 0px 0px 1px #168aff;
           background-color: #7bbcfb;
       }
       50% {
           box-shadow: 0px 0px 5px 0px #168aff;
           background-color: #168aff;
       }
       100% {
           background-color: #7bbcfb;
           box-shadow: 0px 0px 1px #168aff;
       }
    }

    .marker-current-location {
       width: 40px;
       height: 40px;
       border-radius: 40px;
       border: 2px solid white;
       background-color: #168aff;
       box-shadow: 0px 0px 1px #168aff;
       -webkit-animation-name: glow;
       -webkit-animation-duration: 2s;
       -webkit-animation-timing-function: ease-in-out;
       -webkit-animation-iteration-count: infinite;
    }

    .med-location{
      width: 20px;
      height: 20px;
      font-size: 18px;
      text-align: center;
      color: #a61b1b;
      border-radius: 3px;
      font-family: FontAwesome;
    }
    #locate{
      position: fixed;
      right: 10px;
      top: 10px;
    }
    table tr td{
      vertical-align: top;
    }
	</style>
</head>
<body>
  <div id="nav">
      <div class="row">
        <input type="date" id="date"/>
        <input type="time" id="time"/>
        <i id="locate" class="icon-location-arrow"> </i>
      </div>
  </div>
	<div id="map">
	</div>
  <script src="//cdnjs.cloudflare.com/ajax/libs/zepto/1.0/zepto.min.js"></script>
	<script src="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.js"></script>
	<script>
    L_PREFER_CANVAS = true;
		$(function(){
			"use strict";
      
      var showZoomControl = true;
      var layer = null;
      var currentLocation = null;
      
			var map = L.map('map', {
        zoomControl : ('ontouchstart' in window)
      }).setView([39.9500, -75.1700], 13);

			L.tileLayer('http://{s}.tile.cloudmade.com/f7210b3965cb4109a0ae47a7d668d1e5/110685/256/{z}/{x}/{y}.png', {
    		attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors,'+
    					'<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery &copy; '+
    					'<a href="http://cloudmade.com">CloudMade</a>, Flu-shot Data <a href="https://github.com/CityOfPhiladelphia/flu-shot-spec">City of Philadelphia</a>',
    			maxZoom: 18
			}).addTo(map);

      
      var retrieveLocations = function(){
        $.getJSON('/locations', {bbox : map.getBounds().toBBoxString()},
        function(data, status, xhr){
          if(layer){
            map.removeLayer(layer);
            layer = null;
          }
            layer = L.geoJson(data, {
              onEachFeature: function (feature, layer) {
                  layer.setIcon(L.divIcon({
                    className: 'med-location',
                    html : "\uf0fe",
                    iconSize : '20px'}));
                    
                  layer.bindPopup("<table class='marker-details'><tr><td>"+ 
                    "<i class='icon-"+feature.properties["marker-symbol"]+"'></i></td><td><b>" + 
                    feature.properties.facility_name + "</b><br/>" + 
                    feature.properties.street1 + "</td></tr></table>");
              }
          });
          layer.addTo(map);
        });
      };

      //listen for map moves, fire appropriate requests.
      map.on('moveend', function(e){
        retrieveLocations();
      });

      map.on('locationfound', function(e){
        if(currentLocation == null)
        {
          map.setView(e.latlng,15);
          var locationMarker = L.divIcon({className: 'marker-current-location'});
          currentLocation = new L.marker(e.latlng, {icon: locationMarker});
          currentLocation.bindPopup("<span>Current Location</span>").addTo(map).openPopup();
        }
        currentLocation.setLatLng(e.latlng);
      });

      $(window).resize(function(){
        $('#map').height($(window).height() - $('#nav').height());
      }).resize();

      $('#locate').click(function(){
        map.locate({ watch: true });
      });

    });
	</script>
</body>
</html>